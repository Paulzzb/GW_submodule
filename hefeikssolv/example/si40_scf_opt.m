clc;
clear all;
close all;
%
% construct Si40 (http://www-wales.ch.cam.ac.uk/~wales/CCD/Si.html) 
%
kssolvpptype('pz-hgh', 'UPF');
%
% 1. construct atoms
%
a1 = Atom('Si');
atomlist = [ ...
a1, a1, a1, a1, a1, a1, a1, a1, a1, a1, ...
a1, a1, a1, a1, a1, a1, a1, a1, a1, a1, ...
a1, a1, a1, a1, a1, a1, a1, a1, a1, a1, ...
a1, a1, a1, a1, a1, a1, a1, a1, a1, a1, ...
];
%
% 2. set up supercell
%
C = 32.0*eye(3);
%
% 3. define the coordinates the atoms 
%
coords = [
          3.18489390948011          7.02286275506166          1.80813143426203
         -0.334847710052408         8.44189814932012          4.17793474997379
          3.71738819111313          7.48561422352958         -2.66575131863677
          5.43983625539697          3.4350400982659          -3.26823689161544
          5.27762134313205          0.867732821035013        -7.04879868112234
         -0.70128253961026          7.32416861115588         -3.54242435395725
         -2.12069046122211          3.90502124262802         -6.1053469321012
          0.993106465008099         0.494269284162443        -5.60422735910329
         -6.70879507291716          5.90068003792009         -0.302176411283378
         -2.55262318222035          7.04457903637246          0.520097679145172
         -7.67431842086791          2.82636285131235          2.98776934635808
          4.64655117013145         -6.59387001873451         -3.44870924790391
          5.42297018638351         -2.23241858280123         -3.77313975273511
          4.02959644335568         -6.53869577596107          1.00667254710094
         -1.50876122260861         -7.46201896688093         -0.453928235780077
          0.879072116162829        -8.89105003652259          3.14829029879783
         -1.4737695954381          -3.30024085065899         -6.25068908005348
          0.235624408009618        -7.21070324935727         -4.69780576026604
          7.04599015712941         -0.857873869216843         0.107275838331911
          8.68303181912465          3.15134010111532         -0.0625273158849896
          6.1959299061449           4.41024926511916          3.6753797089893
          6.83364448800364         -3.89165363089689          3.36242123552911
          4.12010387560297         -2.48778715030008          6.83890179641188
          3.92117008126016          2.3780104032409           7.2137707319511
          0.473657768790152        -4.73659477102446          5.05887407037129
         -0.207972499257093         4.10815421787796          5.79747088613706
         -3.67923629013354          1.6063390684232           4.74749823486798
         -3.46623458562315         -2.87270879504257          4.62376993373955
         -7.29870095730555         -4.59020395364965          2.69855375683053
         -5.80173434607372         -6.83205966552351         -1.06883846800835
         -5.73455280137371          2.83483692499839         -3.54461674790928
         -8.85545034844115         -0.432160472664156        -4.00694492531457
         -5.30894185631551         -3.199169334238           -3.80238407877651
         -8.01865094155911         -0.784392061217451         0.447842137016753
         -3.13166568574316         -3.02084802469692          0.157352458322625
          2.77353962231101         -1.98455147158831          2.17553640567893
         -3.51116162103563          2.31751982079877          0.329248053214818
          1.13837072979347         -3.35054379935195         -2.07747981479257
          2.28323751361659          2.35722755019264          2.57147935757762
          0.794053689737575         3.35763801968726         -1.73024528158432
];

smV = 1.0;

c1 = coords(:,1);
c2 = coords(:,2);
c3 = coords(:,3);

coords(:,1) = (abs(min(c1)) + smV) + c1;
coords(:,2) = (abs(min(c2)) + smV) + c2;
coords(:,3) = (abs(min(c3)) + smV) + c3;

xyzlist = coords;
%
% 4. Configure the molecule (crystal)
%
mol = Molecule('supercell',C, 'atomlist',atomlist, 'xyzlist' ,xyzlist, ...
               'ecut',20, 'name','Si40' );


opt = setksopt();
opt.maxscfiter = 200;
opt.betamix = 0.08;
opt.mixdim = 10;
opt.scftol = 1e-6;

opt = setksopt();
opt = setksopt(opt,'mixtype','broyden','eigmethod','eigs');
[mol,H0,X0,info] = scf(mol, opt);

[mol,H,X,info] = relaxatoms(mol, 3, H0, X0);